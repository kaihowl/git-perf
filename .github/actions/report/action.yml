name: 'Publish git-perf Report'
description: 'Generate and publish git-perf performance reports to GitHub Pages'
author: 'Kai H√∂welmeyer'

branding:
  icon: 'bar-chart-2'
  color: 'blue'

inputs:
  depth:
    description: 'Depth of the report in number of commits'
    required: false
    default: '40'
  report-name:
    description: 'Name of the report file (without .html extension). If empty, uses branch name or commit SHA'
    required: false
    default: ''
  additional-args:
    description: 'Additional arguments to git-perf report invocation'
    required: false
    default: ''
  audit-args:
    description: 'Additional arguments to git-perf audit invocation'
    required: false
    default: ''
  git-perf-version:
    description: 'Version of git-perf to use (latest, specific version, or `skip` to use already installed version)'
    required: false
    default: 'latest'
  github-token:
    description: 'GitHub token for publishing to gh-pages'
    required: true
  comment-on-pr:
    description: 'Whether to comment on the PR with the report URL (only applies to pull_request events)'
    required: false
    default: 'true'
  show-size:
    description: 'Whether to show measurement storage size in output'
    required: false
    default: 'false'
  size-use-disk-size:
    description: 'Whether to use disk-size (compressed) instead of logical size'
    required: false
    default: 'true'
  reports-subdirectory:
    description: 'Subdirectory within gh-pages for reports (e.g., "perf", "reports"). Empty for root.'
    required: false
    default: ''
  preserve-existing:
    description: 'Preserve existing gh-pages content outside reports subdirectory'
    required: false
    default: 'true'
  show-epochs:
    description: 'Whether to show epoch boundaries in the report'
    required: false
    default: 'false'
  show-changes:
    description: 'Whether to detect and display change points in the report'
    required: false
    default: 'false'
  template:
    description: 'Path to custom report template (relative to repo root). If empty, uses no template.'
    required: false
    default: ''

outputs:
  report-url:
    description: 'URL of the published report'
    value: ${{ steps.get-pages-url.outputs.full-report-url }}
  audit-output:
    description: 'Output from git-perf audit command'
    value: ${{ steps.audit.outputs.audit-output }}
  size-output:
    description: 'Output from git-perf size command'
    value: ${{ steps.size.outputs.size-output }}

runs:
  using: composite
  steps:
    - name: Validate subdirectory input
      shell: bash
      run: |
        SUBDIR="${{ inputs.reports-subdirectory }}"
        if [ -n "$SUBDIR" ]; then
          # Security: Reject paths containing .., absolute paths, or invalid characters
          if [[ "$SUBDIR" =~ \.\. ]] || [[ "$SUBDIR" == /* ]] || [[ ! "$SUBDIR" =~ ^[a-zA-Z0-9_/-]+$ ]]; then
            echo "Error: Invalid subdirectory path '$SUBDIR'"
            echo "Subdirectory must:"
            echo "  - Not contain '..' (parent directory references)"
            echo "  - Not be an absolute path (starting with /)"
            echo "  - Only contain alphanumeric characters, underscores, hyphens, and forward slashes"
            exit 1
          fi
          echo "‚úì Subdirectory validation passed: $SUBDIR"
        else
          echo "‚úì Using root directory (no subdirectory specified)"
        fi

    - name: Install git-perf (from release version)
      if: ${{ inputs.git-perf-version != 'skip' }}
      shell: bash
      run: |
        latest=""
        version=""
        if [ "${{ inputs.git-perf-version }}" = "latest" ]; then
          latest="latest/"
        else
          version="${{ inputs.git-perf-version }}/"
        fi
        download_url="https://github.com/kaihowl/git-perf/releases/${latest}download/${version}git-perf-installer.sh"
        echo "Downloading $download_url"
        curl --proto '=https' --tlsv1.2 -LsSf "$download_url" | sh
        export PATH=$HOME/.cargo/bin:$PATH
        git-perf --help
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v5

    - name: Set report name
      id: set-report-name
      shell: bash
      run: |
        if [ -n "${{ inputs.report-name }}" ]; then
          REPORT_NAME="${{ inputs.report-name }}"
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          REPORT_NAME="$(git rev-parse HEAD)"
        else
          REPORT_NAME="${GITHUB_REF_SLUG}"
        fi
        echo "report-name=$REPORT_NAME" >> $GITHUB_OUTPUT
        echo "Using report name: $REPORT_NAME"

    - name: Generate report
      shell: bash
      run: |
        # Add error handling for git perf pull
        if ! git perf pull; then
          echo "Warning: git perf pull failed, but continuing with report generation"
          echo "This may be due to missing git objects in the repository"
        fi
        mkdir -p reports/

        # Build optional flags
        EPOCH_FLAG=""
        if [ "${{ inputs.show-epochs }}" = "true" ]; then
          EPOCH_FLAG="--show-epochs"
        fi

        CHANGES_FLAG=""
        if [ "${{ inputs.show-changes }}" = "true" ]; then
          CHANGES_FLAG="--show-changes"
        fi

        TEMPLATE_FLAG=""
        if [ -n "${{ inputs.template }}" ]; then
          if [ -f "${{ inputs.template }}" ]; then
            TEMPLATE_FLAG="--template ${{ inputs.template }}"
            echo "Using custom template: ${{ inputs.template }}"
          else
            echo "::error::Template file not found: ${{ inputs.template }}"
            echo "::error::Please ensure the template file exists in your repository"
            echo "::error::Available templates: .git-perf/templates/performance-overview.html, .git-perf/templates/simple-dashboard.html"
            exit 1
          fi
        fi

        git perf report -n ${{ inputs.depth }} -o reports/${{ steps.set-report-name.outputs.report-name }}.html $EPOCH_FLAG $CHANGES_FLAG $TEMPLATE_FLAG ${{ inputs.additional-args }}

    - name: Run audit
      id: audit
      shell: bash
      if: ${{ inputs.audit-args != '' }}
      run: |
        {
          echo 'audit-output<<EOF'
          git perf audit -n ${{ inputs.depth }} ${{ inputs.audit-args }} 2>&1 || echo "Audit failed, but continuing..."
          echo EOF
        } >> "$GITHUB_OUTPUT"

    - name: Show measurement storage size
      id: size
      shell: bash
      if: ${{ inputs.show-size == 'true' }}
      run: |
        # Determine size flags based on inputs
        SIZE_FLAGS=""
        if [ "${{ inputs.size-use-disk-size }}" = "true" ]; then
          SIZE_FLAGS="--disk-size"
          echo "=== Measurement Storage Size (On-Disk) ==="
        else
          echo "=== Measurement Storage Size (Logical) ==="
        fi

        {
          echo 'size-output<<EOF'
          git perf size $SIZE_FLAGS --include-objects 2>&1 || echo "Size command failed, but continuing..."
          echo EOF
        } >> "$GITHUB_OUTPUT"

        # Also display to workflow log
        git perf size $SIZE_FLAGS --include-objects || true

        echo ""
        if [ "${{ inputs.size-use-disk-size }}" = "true" ]; then
          echo "=== Detailed Breakdown (On-Disk) ==="
        else
          echo "=== Detailed Breakdown (Logical) ==="
        fi
        git perf size $SIZE_FLAGS --detailed || true

    - name: Publish to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ inputs.github-token }}
        publish_dir: ./reports
        destination_dir: ${{ inputs.reports-subdirectory }}
        keep_files: ${{ inputs.preserve-existing == 'true' }}

    - name: Get Pages URL
      id: get-pages-url
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        # Check if GitHub Pages is configured
        if ! pages_url=$(gh api repos/${{ github.repository }}/pages --jq '.html_url' 2>&1); then
          echo "::error::GitHub Pages is not configured for this repository!"
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìÑ GitHub Pages Setup Required"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "The report action has successfully generated your performance report,"
          echo "but cannot publish it because GitHub Pages is not yet configured."
          echo ""
          echo "To fix this, follow these steps:"
          echo ""
          echo "1. Go to your repository Settings ‚Üí Pages"
          echo "   https://github.com/${{ github.repository }}/settings/pages"
          echo ""
          echo "2. Under 'Build and deployment':"
          echo "   - Source: Select 'Deploy from a branch'"
          echo "   - Branch: Select 'gh-pages' and '/ (root)'"
          echo "   - Click 'Save'"
          echo ""
          echo "3. Wait a few minutes for GitHub Pages to initialize"
          echo ""
          echo "4. Re-run this workflow:"
          echo "   - Go to the Actions tab"
          echo "   - Click on this workflow run"
          echo "   - Click 'Re-run all jobs'"
          echo ""
          echo "Note: The 'gh-pages' branch was created by the previous step in this"
          echo "workflow. If you don't see it in the dropdown, refresh the page or"
          echo "wait a moment for GitHub to update."
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          exit 1
        fi

        echo "pages-url=$pages_url" >> $GITHUB_OUTPUT
        echo "Pages URL: $pages_url"

        # Construct full report URL including subdirectory
        SUBDIR="${{ inputs.reports-subdirectory }}"
        REPORT_NAME="${{ steps.set-report-name.outputs.report-name }}"
        if [ -n "$SUBDIR" ]; then
          # Remove trailing slash from pages_url if present
          pages_url="${pages_url%/}"
          full_report_url="${pages_url}/${SUBDIR}/${REPORT_NAME}.html"
        else
          full_report_url="${pages_url}/${REPORT_NAME}.html"
        fi
        echo "full-report-url=$full_report_url" >> $GITHUB_OUTPUT
        echo "Full report URL: $full_report_url"

    - name: Comment on PR
      if: ${{ github.event_name == 'pull_request' && inputs.comment-on-pr == 'true' }}
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const reportUrl = '${{ steps.get-pages-url.outputs.full-report-url }}'

          const auditOutput = `${{ steps.audit.outputs.audit-output }}`.trim()
          const auditSection = auditOutput ? `\n\n## Audit Results\n\n\`\`\`\n${auditOutput}\n\`\`\`` : ''

          const sizeOutput = `${{ steps.size.outputs.size-output }}`.trim()
          const sizeSection = sizeOutput ? `\n\n## Measurement Storage Size\n\n\`\`\`\n${sizeOutput}\n\`\`\`` : ''

          const commentBody = `## Performance Report\n\n‚è±  [Performance Results](${reportUrl})${auditSection}${sizeSection}\n\n_Created by [git-perf](https://github.com/kaihowl/git-perf/)_`

          // Find existing performance comment
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          })

          const existingComment = comments.data.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('‚è±  [Performance Results]')
          )

          if (existingComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: commentBody
            })
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            })
          }
