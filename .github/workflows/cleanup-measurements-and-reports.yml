name: 'Cleanup Old Measurements and Reports'

on:
  schedule:
    # Run every Sunday at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual triggering
  pull_request:
    paths:
      - '.github/actions/cleanup/**'
      - '.github/workflows/cleanup-measurements-and-reports.yml'
      - 'cli_types/src/lib.rs'
      - 'git_perf/src/git/git_interop.rs'

permissions:
  contents: write
  pages: write
  issues: write

jobs:
  cleanup:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full checkout required for git perf remove/prune operations

      # Build from source when running on PR to test the changes
      - name: Build git-perf from source (PR only)
        if: github.event_name == 'pull_request'
        run: |
          cargo build --release
          echo "$PWD/target/release" >> $GITHUB_PATH

      - name: Cleanup old measurements and reports
        uses: ./.github/actions/cleanup
        with:
          retention-days: 730
          backup: true
          cleanup-reports: true
          git-perf-version: ${{ github.event_name == 'pull_request' && 'skip' || 'latest' }}
          dry-run: ${{ github.event_name == 'pull_request' }}

      - name: Create issue on scheduled workflow failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”´ Scheduled Cleanup Workflow Failed';
            const body = `## Workflow Failure Report

            The scheduled cleanup workflow has failed.

            **Workflow:** Cleanup Old Measurements and Reports
            **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Triggered:** ${{ github.event_name }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Time:** ${new Date().toISOString()}

            ### Action Required

            Please investigate the failure and take appropriate action.

            ### Useful Links

            - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/.github/workflows/cleanup-measurements-and-reports.yml)

            ---
            *This issue was automatically created by the scheduled workflow failure detector.*`;

            // Check if a similar issue already exists (open issues with the same title)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,workflow-failure',
              per_page: 100
            });

            const duplicateIssue = existingIssues.data.find(issue =>
              issue.title === title
            );

            if (duplicateIssue) {
              // Add a comment to the existing issue instead of creating a new one
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: duplicateIssue.number,
                body: `Another failure occurred:\n\n**Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n**Time:** ${new Date().toISOString()}`
              });
              console.log(`Added comment to existing issue #${duplicateIssue.number}`);
            } else {
              // Create a new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated', 'workflow-failure', 'bug']
              });
              console.log(`Created issue #${issue.data.number}`);
            }
