name: Publish Check

on:
  pull_request:
    branches: [ master ]

jobs:
  publish-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Check cargo publish (dry-run)
        run: |
          # Verify both packages can be packaged and published
          # Order matters: cli_types has no workspace deps, git-perf depends on cli_types

          # First, package cli_types (no workspace dependencies, can verify fully)
          cargo package --package git_perf_cli_types --allow-dirty

          # Package git-perf with --no-verify since it depends on unpublished cli_types changes
          # The verification would fail trying to build against the published cli_types version
          cargo package --package git-perf --allow-dirty --no-verify

          # Verify cli_types can be published (no workspace dependencies)
          cargo publish --dry-run --package git_perf_cli_types --allow-dirty

          # For git-perf: use --no-verify to skip the build check that would fail
          # when cli_types has unpublished changes.
          cargo publish --dry-run --package git-perf --allow-dirty --no-verify
