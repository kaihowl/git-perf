name: Slow Test Loop

# This workflow runs the slow bash tests in a loop until they fail
# It's designed to catch intermittent failures that might not show up in single test runs
# Runs weekly on Saturdays

concurrency:
  group: slow-test-loop-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

on:
  schedule:
    # Run every Saturday at 2 AM UTC
    - cron: '0 2 * * 6'
  workflow_dispatch:  # Allow manual triggering

jobs:
  slow-test-loop:
    name: Slow Test Loop (until failure)
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # 2 hours maximum runtime
    
    env:
      # Emit backtraces on panics
      RUST_BACKTRACE: 1
      # Set a reasonable timeout for individual test runs
      CARGO_TEST_TIMEOUT: 300
      GH_TOKEN: ${{ github.token }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable

    - name: Install nextest
      uses: taiki-e/install-action@nextest

    - name: Build git-perf
      run: cargo build --verbose

    - name: Run slow tests in loop until failure
      run: |
        echo "Starting slow test loop - will run until failure..."
        echo "================================================"

        # Use the existing script but capture output for PR comments
        if bash test/run_test_loop.sh; then
          echo "âœ… All iterations passed without failure!"
        else
          echo "âŒ Test FAILED in the loop!"
          exit 1
        fi

    - name: Create issue on scheduled workflow failure
      if: failure() && github.event_name == 'schedule'
      uses: actions/github-script@v8
      with:
        script: |
          const title = 'ðŸ”´ Scheduled Slow Test Loop Failed';
          const body = `## Workflow Failure Report

          The scheduled slow test loop has detected a failure.

          **Workflow:** Slow Test Loop
          **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **Triggered:** ${{ github.event_name }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Time:** ${new Date().toISOString()}

          ### Action Required

          The slow test loop runs tests repeatedly to catch intermittent failures. A failure here indicates:
          - A flaky test that fails inconsistently
          - Race conditions or timing-dependent bugs
          - Resource cleanup issues

          Please investigate the test failure in the workflow logs.

          ### Useful Links

          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/.github/workflows/slow-test-loop.yml)
          - [Test Script](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/test/run_test_loop.sh)

          ---
          *This issue was automatically created by the scheduled workflow failure detector.*`;

          // Check if a similar issue already exists (open issues with the same title)
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'automated,workflow-failure',
            per_page: 100
          });

          const duplicateIssue = existingIssues.data.find(issue =>
            issue.title === title
          );

          if (duplicateIssue) {
            // Add a comment to the existing issue instead of creating a new one
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: duplicateIssue.number,
              body: `Another failure occurred:\n\n**Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n**Time:** ${new Date().toISOString()}`
            });
            console.log(`Added comment to existing issue #${duplicateIssue.number}`);
          } else {
            // Create a new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated', 'workflow-failure', 'bug', 'flaky-test']
            });
            console.log(`Created issue #${issue.data.number}`);
          }